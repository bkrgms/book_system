{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2019 gRPC authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ServerDuplexStreamImpl = exports.ServerWritableStreamImpl = exports.ServerReadableStreamImpl = exports.ServerUnaryCallImpl = exports.serverErrorToStatus = void 0;\nconst events_1 = require(\"events\");\nconst stream_1 = require(\"stream\");\nconst constants_1 = require(\"./constants\");\nconst metadata_1 = require(\"./metadata\");\nfunction serverErrorToStatus(error, overrideTrailers) {\n  var _a;\n  const status = {\n    code: constants_1.Status.UNKNOWN,\n    details: 'message' in error ? error.message : 'Unknown Error',\n    metadata: (_a = overrideTrailers !== null && overrideTrailers !== void 0 ? overrideTrailers : error.metadata) !== null && _a !== void 0 ? _a : null\n  };\n  if ('code' in error && typeof error.code === 'number' && Number.isInteger(error.code)) {\n    status.code = error.code;\n    if ('details' in error && typeof error.details === 'string') {\n      status.details = error.details;\n    }\n  }\n  return status;\n}\nexports.serverErrorToStatus = serverErrorToStatus;\nclass ServerUnaryCallImpl extends events_1.EventEmitter {\n  constructor(path, call, metadata, request) {\n    super();\n    this.path = path;\n    this.call = call;\n    this.metadata = metadata;\n    this.request = request;\n    this.cancelled = false;\n  }\n  getPeer() {\n    return this.call.getPeer();\n  }\n  sendMetadata(responseMetadata) {\n    this.call.sendMetadata(responseMetadata);\n  }\n  getDeadline() {\n    return this.call.getDeadline();\n  }\n  getPath() {\n    return this.path;\n  }\n  getHost() {\n    return this.call.getHost();\n  }\n}\nexports.ServerUnaryCallImpl = ServerUnaryCallImpl;\nclass ServerReadableStreamImpl extends stream_1.Readable {\n  constructor(path, call, metadata) {\n    super({\n      objectMode: true\n    });\n    this.path = path;\n    this.call = call;\n    this.metadata = metadata;\n    this.cancelled = false;\n  }\n  _read(size) {\n    this.call.startRead();\n  }\n  getPeer() {\n    return this.call.getPeer();\n  }\n  sendMetadata(responseMetadata) {\n    this.call.sendMetadata(responseMetadata);\n  }\n  getDeadline() {\n    return this.call.getDeadline();\n  }\n  getPath() {\n    return this.path;\n  }\n  getHost() {\n    return this.call.getHost();\n  }\n}\nexports.ServerReadableStreamImpl = ServerReadableStreamImpl;\nclass ServerWritableStreamImpl extends stream_1.Writable {\n  constructor(path, call, metadata, request) {\n    super({\n      objectMode: true\n    });\n    this.path = path;\n    this.call = call;\n    this.metadata = metadata;\n    this.request = request;\n    this.pendingStatus = {\n      code: constants_1.Status.OK,\n      details: 'OK'\n    };\n    this.cancelled = false;\n    this.trailingMetadata = new metadata_1.Metadata();\n    this.on('error', err => {\n      this.pendingStatus = serverErrorToStatus(err);\n      this.end();\n    });\n  }\n  getPeer() {\n    return this.call.getPeer();\n  }\n  sendMetadata(responseMetadata) {\n    this.call.sendMetadata(responseMetadata);\n  }\n  getDeadline() {\n    return this.call.getDeadline();\n  }\n  getPath() {\n    return this.path;\n  }\n  getHost() {\n    return this.call.getHost();\n  }\n  _write(chunk, encoding,\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  callback) {\n    this.call.sendMessage(chunk, callback);\n  }\n  _final(callback) {\n    var _a;\n    callback(null);\n    this.call.sendStatus(Object.assign(Object.assign({}, this.pendingStatus), {\n      metadata: (_a = this.pendingStatus.metadata) !== null && _a !== void 0 ? _a : this.trailingMetadata\n    }));\n  }\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  end(metadata) {\n    if (metadata) {\n      this.trailingMetadata = metadata;\n    }\n    return super.end();\n  }\n}\nexports.ServerWritableStreamImpl = ServerWritableStreamImpl;\nclass ServerDuplexStreamImpl extends stream_1.Duplex {\n  constructor(path, call, metadata) {\n    super({\n      objectMode: true\n    });\n    this.path = path;\n    this.call = call;\n    this.metadata = metadata;\n    this.pendingStatus = {\n      code: constants_1.Status.OK,\n      details: 'OK'\n    };\n    this.cancelled = false;\n    this.trailingMetadata = new metadata_1.Metadata();\n    this.on('error', err => {\n      this.pendingStatus = serverErrorToStatus(err);\n      this.end();\n    });\n  }\n  getPeer() {\n    return this.call.getPeer();\n  }\n  sendMetadata(responseMetadata) {\n    this.call.sendMetadata(responseMetadata);\n  }\n  getDeadline() {\n    return this.call.getDeadline();\n  }\n  getPath() {\n    return this.path;\n  }\n  getHost() {\n    return this.call.getHost();\n  }\n  _read(size) {\n    this.call.startRead();\n  }\n  _write(chunk, encoding,\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  callback) {\n    this.call.sendMessage(chunk, callback);\n  }\n  _final(callback) {\n    var _a;\n    callback(null);\n    this.call.sendStatus(Object.assign(Object.assign({}, this.pendingStatus), {\n      metadata: (_a = this.pendingStatus.metadata) !== null && _a !== void 0 ? _a : this.trailingMetadata\n    }));\n  }\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  end(metadata) {\n    if (metadata) {\n      this.trailingMetadata = metadata;\n    }\n    return super.end();\n  }\n}\nexports.ServerDuplexStreamImpl = ServerDuplexStreamImpl;","map":{"version":3,"names":["events_1","require","stream_1","constants_1","metadata_1","serverErrorToStatus","error","overrideTrailers","status","code","Status","UNKNOWN","details","message","metadata","_a","Number","isInteger","exports","ServerUnaryCallImpl","EventEmitter","constructor","path","call","request","cancelled","getPeer","sendMetadata","responseMetadata","getDeadline","getPath","getHost","ServerReadableStreamImpl","Readable","objectMode","_read","size","startRead","ServerWritableStreamImpl","Writable","pendingStatus","OK","trailingMetadata","Metadata","on","err","end","_write","chunk","encoding","callback","sendMessage","_final","sendStatus","Object","assign","ServerDuplexStreamImpl","Duplex"],"sources":["../../src/server-call.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}