{"ast":null,"code":"\"use strict\";\n\n/*\n * Copyright 2019 gRPC authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\nrequire(\"core-js/modules/esnext.iterator.constructor.js\");\nrequire(\"core-js/modules/esnext.iterator.filter.js\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ResolvingLoadBalancer = void 0;\nconst load_balancer_1 = require(\"./load-balancer\");\nconst service_config_1 = require(\"./service-config\");\nconst connectivity_state_1 = require(\"./connectivity-state\");\nconst resolver_1 = require(\"./resolver\");\nconst picker_1 = require(\"./picker\");\nconst backoff_timeout_1 = require(\"./backoff-timeout\");\nconst constants_1 = require(\"./constants\");\nconst metadata_1 = require(\"./metadata\");\nconst logging = require(\"./logging\");\nconst constants_2 = require(\"./constants\");\nconst uri_parser_1 = require(\"./uri-parser\");\nconst load_balancer_child_handler_1 = require(\"./load-balancer-child-handler\");\nconst TRACER_NAME = 'resolving_load_balancer';\nfunction trace(text) {\n  logging.trace(constants_2.LogVerbosity.DEBUG, TRACER_NAME, text);\n}\n/**\n * Name match levels in order from most to least specific. This is the order in\n * which searches will be performed.\n */\nconst NAME_MATCH_LEVEL_ORDER = ['SERVICE_AND_METHOD', 'SERVICE', 'EMPTY'];\nfunction hasMatchingName(service, method, methodConfig, matchLevel) {\n  for (const name of methodConfig.name) {\n    switch (matchLevel) {\n      case 'EMPTY':\n        if (!name.service && !name.method) {\n          return true;\n        }\n        break;\n      case 'SERVICE':\n        if (name.service === service && !name.method) {\n          return true;\n        }\n        break;\n      case 'SERVICE_AND_METHOD':\n        if (name.service === service && name.method === method) {\n          return true;\n        }\n    }\n  }\n  return false;\n}\nfunction findMatchingConfig(service, method, methodConfigs, matchLevel) {\n  for (const config of methodConfigs) {\n    if (hasMatchingName(service, method, config, matchLevel)) {\n      return config;\n    }\n  }\n  return null;\n}\nfunction getDefaultConfigSelector(serviceConfig) {\n  return function defaultConfigSelector(methodName, metadata) {\n    var _a, _b;\n    const splitName = methodName.split('/').filter(x => x.length > 0);\n    const service = (_a = splitName[0]) !== null && _a !== void 0 ? _a : '';\n    const method = (_b = splitName[1]) !== null && _b !== void 0 ? _b : '';\n    if (serviceConfig && serviceConfig.methodConfig) {\n      /* Check for the following in order, and return the first method\n       * config that matches:\n       * 1. A name that exactly matches the service and method\n       * 2. A name with no method set that matches the service\n       * 3. An empty name\n       */\n      for (const matchLevel of NAME_MATCH_LEVEL_ORDER) {\n        const matchingConfig = findMatchingConfig(service, method, serviceConfig.methodConfig, matchLevel);\n        if (matchingConfig) {\n          return {\n            methodConfig: matchingConfig,\n            pickInformation: {},\n            status: constants_1.Status.OK,\n            dynamicFilterFactories: []\n          };\n        }\n      }\n    }\n    return {\n      methodConfig: {\n        name: []\n      },\n      pickInformation: {},\n      status: constants_1.Status.OK,\n      dynamicFilterFactories: []\n    };\n  };\n}\nclass ResolvingLoadBalancer {\n  /**\n   * Wrapper class that behaves like a `LoadBalancer` and also handles name\n   * resolution internally.\n   * @param target The address of the backend to connect to.\n   * @param channelControlHelper `ChannelControlHelper` instance provided by\n   *     this load balancer's owner.\n   * @param defaultServiceConfig The default service configuration to be used\n   *     if none is provided by the name resolver. A `null` value indicates\n   *     that the default behavior should be the default unconfigured behavior.\n   *     In practice, that means using the \"pick first\" load balancer\n   *     implmentation\n   */\n  constructor(target, channelControlHelper, credentials, channelOptions, onSuccessfulResolution, onFailedResolution) {\n    this.target = target;\n    this.channelControlHelper = channelControlHelper;\n    this.onSuccessfulResolution = onSuccessfulResolution;\n    this.onFailedResolution = onFailedResolution;\n    this.latestChildState = connectivity_state_1.ConnectivityState.IDLE;\n    this.latestChildPicker = new picker_1.QueuePicker(this);\n    /**\n     * This resolving load balancer's current connectivity state.\n     */\n    this.currentState = connectivity_state_1.ConnectivityState.IDLE;\n    /**\n     * The service config object from the last successful resolution, if\n     * available. A value of null indicates that we have not yet received a valid\n     * service config from the resolver.\n     */\n    this.previousServiceConfig = null;\n    /**\n     * Indicates whether we should attempt to resolve again after the backoff\n     * timer runs out.\n     */\n    this.continueResolving = false;\n    if (channelOptions['grpc.service_config']) {\n      this.defaultServiceConfig = (0, service_config_1.validateServiceConfig)(JSON.parse(channelOptions['grpc.service_config']));\n    } else {\n      this.defaultServiceConfig = {\n        loadBalancingConfig: [],\n        methodConfig: []\n      };\n    }\n    this.updateState(connectivity_state_1.ConnectivityState.IDLE, new picker_1.QueuePicker(this));\n    this.childLoadBalancer = new load_balancer_child_handler_1.ChildLoadBalancerHandler({\n      createSubchannel: channelControlHelper.createSubchannel.bind(channelControlHelper),\n      requestReresolution: () => {\n        /* If the backoffTimeout is running, we're still backing off from\n         * making resolve requests, so we shouldn't make another one here.\n         * In that case, the backoff timer callback will call\n         * updateResolution */\n        if (this.backoffTimeout.isRunning()) {\n          trace('requestReresolution delayed by backoff timer until ' + this.backoffTimeout.getEndTime().toISOString());\n          this.continueResolving = true;\n        } else {\n          this.updateResolution();\n        }\n      },\n      updateState: (newState, picker) => {\n        this.latestChildState = newState;\n        this.latestChildPicker = picker;\n        this.updateState(newState, picker);\n      },\n      addChannelzChild: channelControlHelper.addChannelzChild.bind(channelControlHelper),\n      removeChannelzChild: channelControlHelper.removeChannelzChild.bind(channelControlHelper)\n    }, credentials, channelOptions);\n    this.innerResolver = (0, resolver_1.createResolver)(target, {\n      onSuccessfulResolution: (endpointList, serviceConfig, serviceConfigError, configSelector, attributes) => {\n        var _a;\n        this.backoffTimeout.stop();\n        this.backoffTimeout.reset();\n        let workingServiceConfig = null;\n        /* This first group of conditionals implements the algorithm described\n         * in https://github.com/grpc/proposal/blob/master/A21-service-config-error-handling.md\n         * in the section called \"Behavior on receiving a new gRPC Config\".\n         */\n        if (serviceConfig === null) {\n          // Step 4 and 5\n          if (serviceConfigError === null) {\n            // Step 5\n            this.previousServiceConfig = null;\n            workingServiceConfig = this.defaultServiceConfig;\n          } else {\n            // Step 4\n            if (this.previousServiceConfig === null) {\n              // Step 4.ii\n              this.handleResolutionFailure(serviceConfigError);\n            } else {\n              // Step 4.i\n              workingServiceConfig = this.previousServiceConfig;\n            }\n          }\n        } else {\n          // Step 3\n          workingServiceConfig = serviceConfig;\n          this.previousServiceConfig = serviceConfig;\n        }\n        const workingConfigList = (_a = workingServiceConfig === null || workingServiceConfig === void 0 ? void 0 : workingServiceConfig.loadBalancingConfig) !== null && _a !== void 0 ? _a : [];\n        const loadBalancingConfig = (0, load_balancer_1.selectLbConfigFromList)(workingConfigList, true);\n        if (loadBalancingConfig === null) {\n          // There were load balancing configs but none are supported. This counts as a resolution failure\n          this.handleResolutionFailure({\n            code: constants_1.Status.UNAVAILABLE,\n            details: 'All load balancer options in service config are not compatible',\n            metadata: new metadata_1.Metadata()\n          });\n          return;\n        }\n        this.childLoadBalancer.updateAddressList(endpointList, loadBalancingConfig, attributes);\n        const finalServiceConfig = workingServiceConfig !== null && workingServiceConfig !== void 0 ? workingServiceConfig : this.defaultServiceConfig;\n        this.onSuccessfulResolution(finalServiceConfig, configSelector !== null && configSelector !== void 0 ? configSelector : getDefaultConfigSelector(finalServiceConfig));\n      },\n      onError: error => {\n        this.handleResolutionFailure(error);\n      }\n    }, channelOptions);\n    const backoffOptions = {\n      initialDelay: channelOptions['grpc.initial_reconnect_backoff_ms'],\n      maxDelay: channelOptions['grpc.max_reconnect_backoff_ms']\n    };\n    this.backoffTimeout = new backoff_timeout_1.BackoffTimeout(() => {\n      if (this.continueResolving) {\n        this.updateResolution();\n        this.continueResolving = false;\n      } else {\n        this.updateState(this.latestChildState, this.latestChildPicker);\n      }\n    }, backoffOptions);\n    this.backoffTimeout.unref();\n  }\n  updateResolution() {\n    this.innerResolver.updateResolution();\n    if (this.currentState === connectivity_state_1.ConnectivityState.IDLE) {\n      /* this.latestChildPicker is initialized as new QueuePicker(this), which\n       * is an appropriate value here if the child LB policy is unset.\n       * Otherwise, we want to delegate to the child here, in case that\n       * triggers something. */\n      this.updateState(connectivity_state_1.ConnectivityState.CONNECTING, this.latestChildPicker);\n    }\n    this.backoffTimeout.runOnce();\n  }\n  updateState(connectivityState, picker) {\n    trace((0, uri_parser_1.uriToString)(this.target) + ' ' + connectivity_state_1.ConnectivityState[this.currentState] + ' -> ' + connectivity_state_1.ConnectivityState[connectivityState]);\n    // Ensure that this.exitIdle() is called by the picker\n    if (connectivityState === connectivity_state_1.ConnectivityState.IDLE) {\n      picker = new picker_1.QueuePicker(this, picker);\n    }\n    this.currentState = connectivityState;\n    this.channelControlHelper.updateState(connectivityState, picker);\n  }\n  handleResolutionFailure(error) {\n    if (this.latestChildState === connectivity_state_1.ConnectivityState.IDLE) {\n      this.updateState(connectivity_state_1.ConnectivityState.TRANSIENT_FAILURE, new picker_1.UnavailablePicker(error));\n      this.onFailedResolution(error);\n    }\n  }\n  exitIdle() {\n    if (this.currentState === connectivity_state_1.ConnectivityState.IDLE || this.currentState === connectivity_state_1.ConnectivityState.TRANSIENT_FAILURE) {\n      if (this.backoffTimeout.isRunning()) {\n        this.continueResolving = true;\n      } else {\n        this.updateResolution();\n      }\n    }\n    this.childLoadBalancer.exitIdle();\n  }\n  updateAddressList(endpointList, lbConfig) {\n    throw new Error('updateAddressList not supported on ResolvingLoadBalancer');\n  }\n  resetBackoff() {\n    this.backoffTimeout.reset();\n    this.childLoadBalancer.resetBackoff();\n  }\n  destroy() {\n    this.childLoadBalancer.destroy();\n    this.innerResolver.destroy();\n    this.backoffTimeout.reset();\n    this.backoffTimeout.stop();\n    this.latestChildState = connectivity_state_1.ConnectivityState.IDLE;\n    this.latestChildPicker = new picker_1.QueuePicker(this);\n    this.currentState = connectivity_state_1.ConnectivityState.IDLE;\n    this.previousServiceConfig = null;\n    this.continueResolving = false;\n  }\n  getTypeName() {\n    return 'resolving_load_balancer';\n  }\n}\nexports.ResolvingLoadBalancer = ResolvingLoadBalancer;","map":{"version":3,"names":["require","load_balancer_1","service_config_1","connectivity_state_1","resolver_1","picker_1","backoff_timeout_1","constants_1","metadata_1","logging","constants_2","uri_parser_1","load_balancer_child_handler_1","TRACER_NAME","trace","text","LogVerbosity","DEBUG","NAME_MATCH_LEVEL_ORDER","hasMatchingName","service","method","methodConfig","matchLevel","name","findMatchingConfig","methodConfigs","config","getDefaultConfigSelector","serviceConfig","defaultConfigSelector","methodName","metadata","splitName","split","filter","x","length","_a","_b","matchingConfig","pickInformation","status","Status","OK","dynamicFilterFactories","ResolvingLoadBalancer","constructor","target","channelControlHelper","credentials","channelOptions","onSuccessfulResolution","onFailedResolution","latestChildState","ConnectivityState","IDLE","latestChildPicker","QueuePicker","currentState","previousServiceConfig","continueResolving","defaultServiceConfig","validateServiceConfig","JSON","parse","loadBalancingConfig","updateState","childLoadBalancer","ChildLoadBalancerHandler","createSubchannel","bind","requestReresolution","backoffTimeout","isRunning","getEndTime","toISOString","updateResolution","newState","picker","addChannelzChild","removeChannelzChild","innerResolver","createResolver","endpointList","serviceConfigError","configSelector","attributes","stop","reset","workingServiceConfig","handleResolutionFailure","workingConfigList","selectLbConfigFromList","code","UNAVAILABLE","details","Metadata","updateAddressList","finalServiceConfig","onError","error","backoffOptions","initialDelay","maxDelay","BackoffTimeout","unref","CONNECTING","runOnce","connectivityState","uriToString","TRANSIENT_FAILURE","UnavailablePicker","exitIdle","lbConfig","Error","resetBackoff","destroy","getTypeName","exports"],"sources":["../../src/resolving-load-balancer.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}